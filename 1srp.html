<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gloria老師班級的成績查詢系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8; /* 淺藍灰色背景 */
        }
        .gradient-bg {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); /* 原始漸層 */
        }
        .teacher-info-bg {
            background-color: #8B5CF6; /* 紫色背景 - Tailwind purple-500 */
        }
        .result-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb; /* 卡片預設邊框 */
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .class-badge {
            transition: all 0.2s ease;
        }
        .class-badge:hover {
            transform: translateY(-2px);
        }
        .class-badge.active {
            box-shadow: 0 0 0 2px #4f46e5; /* 選定班級的靛藍色陰影 */
        }
        /* 自訂選擇箭頭 */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        .score-item {
            background-color: #f9fafb; /* Tailwind gray-50 */
            padding: 1rem;
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            border: 1px solid #e5e7eb; /* Tailwind border-gray-200 */
        }
        .score-label {
            font-size: 0.875rem; /* Tailwind text-sm */
            color: #4b5563; /* Tailwind gray-600 */
            margin-bottom: 0.25rem;
        }
        .score-value {
            font-size: 1.5rem; /* Tailwind text-2xl */
            font-weight: 700; /* Tailwind font-bold */
            color: #1f2937; /* Tailwind gray-800 */
        }
        .rank-value {
             font-size: 1.25rem; /* Tailwind text-xl for ranks */
        }
        .summary-item {
            background-color: #eff6ff; /* Tailwind blue-50 for summary */
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex flex-col">
        <header class="gradient-bg text-white py-6 shadow-lg">
            <div class="container mx-auto px-4">
                <h1 class="text-3xl font-bold text-center">Gloria老師班級的成績查詢系統</h1>
            </div>
        </header>

        <div class="teacher-info-bg text-white py-3 shadow-md">
            <div class="container mx-auto px-4 text-center">
                <p class="text-lg font-semibold">教師：Gloria吳秀蘭老師, Google認證講師, 英文兼台語教師</p>
            </div>
        </div>

        <main class="flex-grow container mx-auto px-4 py-8">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">班級資料管理</h2>
                    <div class="flex flex-wrap gap-3 mb-4" id="classButtons">
                        {/* 班級按鈕將在此動態加入 */}
                    </div>
                    <div class="flex flex-col sm:flex-row sm:justify-between items-center gap-3">
                        <button type="button" id="importButton" class="w-full sm:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-6 rounded-md transition duration-300">
                            匯入新班級資料
                        </button>
                        <button type="button" id="manageClassesButton" class="w-full sm:w-auto bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-6 rounded-md transition duration-300 mt-2 sm:mt-0">
                            管理班級資料
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">請選擇學生查詢</h2>
                    <form id="searchForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="studentId" class="block text-sm font-medium text-gray-700 mb-1">學號</label>
                                <select id="studentId" name="studentId" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">請先選擇班級</option>
                                </select>
                            </div>
                            <div>
                                <label for="studentName" class="block text-sm font-medium text-gray-700 mb-1">姓名</label>
                                 <select id="studentName" name="studentName" required
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">請先選擇班級</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-center pt-2">
                            <button type="submit" id="searchButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-6 rounded-md transition duration-300 flex items-center">
                                <span>查詢成績</span>
                                <span id="loadingIcon" class="loading ml-2 hidden"></span>
                            </button>
                        </div>
                    </form>
                </div>

                <div id="resultsSection" class="hidden fade-in">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 pb-4 border-b border-gray-200">
                            <div>
                                <h2 class="text-2xl font-semibold text-gray-800">成績查詢結果</h2>
                                <p class="text-sm text-gray-500 mt-1" id="resultClassName">班級：--</p>
                            </div>
                            <div class="mt-3 sm:mt-0 text-sm text-left sm:text-right">
                                <p><span class="text-gray-600">座號：</span><span id="resultSeatNumber" class="font-medium text-gray-800">--</span></p>
                                <p><span class="text-gray-600">學號：</span><span id="resultStudentId" class="font-medium text-gray-800">--</span></p>
                                <p><span class="text-gray-600">姓名：</span><span id="resultStudentName" class="font-medium text-gray-800">--</span></p>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-xl font-medium text-gray-700 mb-4">各科成績</h3>
                            <div class="score-grid">
                                <div class="score-item result-card"><div class="score-label">數學Ⅳ</div><div class="score-value" id="score_math4">--</div></div>
                                <div class="score-item result-card"><div class="score-label">地理</div><div class="score-value" id="score_geography">--</div></div>
                                <div class="score-item result-card"><div class="score-label">應用力學</div><div class="score-value" id="score_appliedMechanics">--</div></div>
                                <div class="score-item result-card"><div class="score-label">國語文Ⅳ</div><div class="score-value" id="score_chinese4">--</div></div>
                                <div class="score-item result-card"><div class="score-label">英語文Ⅳ</div><div class="score-value" id="score_english4">--</div></div>
                                <div class="score-item result-card"><div class="score-label">柴油</div><div class="score-value" id="score_diesel">--</div></div>
                                <div class="score-item result-card"><div class="score-label">引擎原理</div><div class="score-value" id="score_enginePrinciples">--</div></div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-xl font-medium text-gray-700 mb-4">排名資訊</h3>
                            <div class="score-grid">
                                <div class="score-item result-card"><div class="score-label">班排名</div><div class="score-value rank-value" id="rank_class">--</div></div>
                                <div class="score-item result-card"><div class="score-label">科組排名</div><div class="score-value rank-value" id="rank_departmentGroup">--</div></div>
                                <div class="score-item result-card"><div class="score-label">科年排名</div><div class="score-value rank-value" id="rank_departmentYear">--</div></div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-medium text-gray-700 mb-4">總結成績</h3>
                            <div class="score-grid">
                                <div class="score-item result-card summary-item"><div class="score-label">一般總分</div><div class="score-value" id="summary_generalTotalScore">--</div></div>
                                <div class="score-item result-card summary-item"><div class="score-label">一般平均</div><div class="score-value" id="summary_generalAverageScore">--</div></div>
                                <div class="score-item result-card summary-item"><div class="score-label">加權總分</div><div class="score-value" id="summary_weightedTotalScore">--</div></div>
                                <div class="score-item result-card summary-item"><div class="score-label">加權平均</div><div class="score-value" id="summary_weightedAverageScore">--</div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="noResultsMessage" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center fade-in">
                    <svg class="w-12 h-12 text-yellow-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-800 mb-2">查無資料</h3>
                    <p class="text-gray-600">找不到符合的學生資料，請確認學號和姓名是否正確，或確認已選擇正確的班級。</p>
                </div>
            </div>
        </main>

        <footer class="bg-gray-800 text-white py-4 mt-auto">
            <div class="container mx-auto px-4 text-center text-sm">
                <p>© 2025 學生成績查詢系統 | 請妥善保管您的成績資訊</p>
            </div>
        </footer>
    </div>

    <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">匯入班級資料</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mb-4">
                <label for="className" class="block text-sm font-medium text-gray-700 mb-2">班級名稱</label>
                <input type="text" id="className" placeholder="例如：一年級汽車科甲班"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-2">
                <p class="text-sm text-gray-600">
                    請先將您的 Google 試算表資料匯出為 CSV 格式檔案。
                </p>
                <p class="text-xs text-gray-500 mt-1">
                    (在 Google 試算表中：檔案 -> 下載 -> 逗號分隔值 (.csv))
                </p>
            </div>
            <div class="mb-4">
                <label for="csvFile" class="block text-sm font-medium text-gray-700 mb-2">選擇 CSV 檔案</label>
                <input type="file" id="csvFile" accept=".csv"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            </div>
            <div class="flex justify-end">
                <button id="confirmImportBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md transition duration-300">
                    匯入資料
                </button>
            </div>
        </div>
    </div>

    <div id="manageClassesModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800">管理班級資料</h3>
                <button id="closeManageModalBtn" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-gray-600 mb-2">已匯入的班級資料：</p>
                <ul id="classesList" class="border border-gray-200 rounded-md divide-y divide-gray-200 max-h-60 overflow-y-auto">
                    {/* 班級列表項目將在此動態加入 */}
                </ul>
            </div>
            <div class="flex justify-end">
                <button id="closeManageBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition duration-300">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <script>
    // 全域變數
    let classData = {}; // 儲存各班級資料的物件: { 班級名稱: [學生物件, ...] }
    let currentClass = null; // 目前選擇的班級名稱 (字串)

    // DOM 元素
    const searchForm = document.getElementById('searchForm');
    const studentIdDropdown = document.getElementById('studentId');
    const studentNameDropdown = document.getElementById('studentName');
    const searchButton = document.getElementById('searchButton');
    const loadingIcon = document.getElementById('loadingIcon');
    const importButton = document.getElementById('importButton');
    const importModal = document.getElementById('importModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const confirmImportBtn = document.getElementById('confirmImportBtn');
    const csvFileInput = document.getElementById('csvFile');
    const classNameInput = document.getElementById('className');
    const resultsSection = document.getElementById('resultsSection');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const classButtons = document.getElementById('classButtons');
    const manageClassesButton = document.getElementById('manageClassesButton');
    const manageClassesModal = document.getElementById('manageClassesModal');
    const closeManageModalBtn = document.getElementById('closeManageModalBtn');
    const closeManageBtn = document.getElementById('closeManageBtn');
    const classesList = document.getElementById('classesList');

    // 事件監聽器
    searchForm.addEventListener('submit', handleSearch);
    importButton.addEventListener('click', openImportModal);
    closeModalBtn.addEventListener('click', closeImportModal);
    confirmImportBtn.addEventListener('click', importCSV);
    manageClassesButton.addEventListener('click', openManageClassesModal);
    closeManageModalBtn.addEventListener('click', closeManageClassesModal);
    closeManageBtn.addEventListener('click', closeManageClassesModal);
    studentIdDropdown.addEventListener('change', syncNameToId);
    studentNameDropdown.addEventListener('change', syncIdToName);

    // --- UI 輔助函式 ---
    function showAlert(message, type = 'info') {
        alert(message); // 簡單提示框
        console.log(`Alert (${type}): ${message}`);
    }

    // --- 核心函式 ---
    function handleSearch(e) {
        e.preventDefault();
        const studentId = studentIdDropdown.value;
        const studentName = studentNameDropdown.value; // 雖然有同步，但表單提交時仍以 ID 為主，姓名再次確認

        if (!studentId || !studentName) {
            showAlert('請選擇學號和姓名。', 'error');
            return;
        }
        if (!currentClass) {
            showAlert('請先選擇班級。', 'error');
            return;
        }

        loadingIcon.classList.remove('hidden');
        searchButton.disabled = true;

        setTimeout(() => {
            const student = findStudentById(studentId);
            // 再次確認選擇的姓名與找到的學生姓名一致
            if (student && student.name === studentNameDropdown.options[studentNameDropdown.selectedIndex].value.split(' - ')[1]?.replace(/\s*\(.*\)$/, '').trim()) {
                displayResults(student);
                resultsSection.classList.remove('hidden');
                noResultsMessage.classList.add('hidden');
            } else {
                resultsSection.classList.add('hidden');
                noResultsMessage.classList.remove('hidden');
            }
            loadingIcon.classList.add('hidden');
            searchButton.disabled = false;
        }, 800); // 模擬延遲
    }

    function findStudentById(id) {
        if (!currentClass || !classData[currentClass]) return null;
        return classData[currentClass].find(student => student.id === id);
    }

    function findStudentByName(name) {
        if (!currentClass || !classData[currentClass]) return null;
        // 由於姓名可能重複，此處僅回傳第一個符合的學生
        return classData[currentClass].find(student => student.name === name);
    }

    /**
     * 在 UI 中顯示學生成績。
     * @param {object} student - 學生資料物件。
     */
    function displayResults(student) {
        const getStudentData = (key) => student[key] || '--'; // 安全取值，若無則顯示 '--'

        // 基本資訊
        document.getElementById('resultSeatNumber').textContent = getStudentData('seatNumber');
        document.getElementById('resultStudentId').textContent = getStudentData('id');
        document.getElementById('resultStudentName').textContent = getStudentData('name');
        document.getElementById('resultClassName').textContent = `班級：${currentClass || '--'}`;

        // 各科成績
        document.getElementById('score_math4').textContent = getStudentData('math4');
        document.getElementById('score_geography').textContent = getStudentData('geography');
        document.getElementById('score_appliedMechanics').textContent = getStudentData('appliedMechanics');
        document.getElementById('score_chinese4').textContent = getStudentData('chinese4');
        document.getElementById('score_english4').textContent = getStudentData('english4');
        document.getElementById('score_diesel').textContent = getStudentData('diesel');
        document.getElementById('score_enginePrinciples').textContent = getStudentData('enginePrinciples');

        // 排名資訊
        document.getElementById('rank_class').textContent = getStudentData('classRank');
        document.getElementById('rank_departmentGroup').textContent = getStudentData('departmentGroupRank');
        document.getElementById('rank_departmentYear').textContent = getStudentData('departmentYearRank');

        // 總結成績
        document.getElementById('summary_generalTotalScore').textContent = getStudentData('generalTotalScore');
        document.getElementById('summary_generalAverageScore').textContent = getStudentData('generalAverageScore');
        document.getElementById('summary_weightedTotalScore').textContent = getStudentData('weightedTotalScore');
        document.getElementById('summary_weightedAverageScore').textContent = getStudentData('weightedAverageScore');
    }

    // --- 彈出視窗管理 ---
    function openImportModal() {
        importModal.classList.remove('hidden');
        classNameInput.value = ''; // 清空班級名稱輸入
        csvFileInput.value = '';   // 清空檔案選擇
    }

    function closeImportModal() {
        importModal.classList.add('hidden');
    }

    function openManageClassesModal() {
        updateClassesList(); // 顯示前先更新列表
        manageClassesModal.classList.remove('hidden');
    }

    function closeManageClassesModal() {
        manageClassesModal.classList.add('hidden');
    }

    // --- CSV 匯入與處理 ---
    function importCSV() {
        const file = csvFileInput.files[0];
        const className = classNameInput.value.trim();

        if (!file) {
            showAlert('請選擇 CSV 檔案。', 'error'); return;
        }
        if (!className) {
            showAlert('請輸入班級名稱。', 'error'); return;
        }
        // 檢查班級名稱是否已存在
        if (classData.hasOwnProperty(className)) {
            if (!confirm(`班級 "${className}" 已存在。要覆蓋現有資料嗎？`)) return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const csvData = e.target.result;
                processCSVData(csvData, className); // 處理 CSV 資料
                closeImportModal();                 // 成功後關閉視窗
                updateClassButtons();               // 更新 UI 中的班級按鈕
                // 如果新匯入的班級是目前選中的班級，則更新學生下拉選單
                if (currentClass === className) {
                    updateStudentSearchDropdowns();
                }
                showAlert(`${className} 資料匯入成功！`, 'success');
            } catch (error) {
                console.error("CSV 匯入錯誤:", error);
                showAlert(`匯入失敗：${error.message}`, 'error');
            }
        };
        reader.onerror = function() { // 檔案讀取錯誤處理
            console.error("FileReader 錯誤:", reader.error);
            showAlert('讀取檔案失敗。', 'error');
        };
        reader.readAsText(file); // 以文字格式讀取檔案
    }

    /**
     * 處理 CSV 文字資料並儲存。
     * @param {string} csvText - CSV 字串資料。
     * @param {string} className - 此班級資料集的名稱。
     */
    function processCSVData(csvText, className) {
        // 將 CSV 文字分割成行並移除空行
        const lines = csvText.split(/\r\n|\n/).filter(line => line.trim());
        if (lines.length < 2) throw new Error("CSV 檔案至少需要包含標頭和一行資料。"); // 必須有標頭和至少一筆資料

        const headers = parseCSVLine(lines[0]); // 從第一行提取標頭
        const students = [];
        for (let i = 1; i < lines.length; i++) { // 處理每一筆資料行
            const values = parseCSVLine(lines[i]);
            if (values.length === headers.length) { // 欄位數需與標頭數相符
                const student = {};
                headers.forEach((header, index) => {
                    const cleanHeader = header.trim(); // 清理標頭空白
                    const value = values[index] ? values[index].trim() : ''; // 清理值空白，若無則空字串
                    // 根據預期的中文標頭對應 CSV 欄位至學生物件屬性
                    switch(cleanHeader) {
                        case '座號': student.seatNumber = value; break;
                        case '姓名': student.name = value; break;
                        case '學號': student.id = value; break;
                        case '數學Ⅳ': student.math4 = value; break;
                        case '地理': student.geography = value; break;
                        case '應用力學': student.appliedMechanics = value; break;
                        case '國語文Ⅳ': student.chinese4 = value; break;
                        case '英語文Ⅳ': student.english4 = value; break;
                        case '柴油': student.diesel = value; break;
                        case '引擎原理': student.enginePrinciples = value; break;
                        case '班排名': student.classRank = value; break;
                        case '科組排名': student.departmentGroupRank = value; break;
                        case '科年排名': student.departmentYearRank = value; break;
                        case '一般總分': student.generalTotalScore = value; break;
                        case '一般平均': student.generalAverageScore = value; break;
                        case '加權總分': student.weightedTotalScore = value; break;
                        case '加權平均': student.weightedAverageScore = value; break;
                        default:
                            // 可選擇性儲存其他未對應的欄位
                            // student[cleanHeader.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')] = value;
                            // console.warn(`未對應的 CSV 標頭: "${cleanHeader}"`);
                            break; // 目前忽略未對應欄位以保持資料乾淨
                    }
                });
                // 基本驗證：確保學生有座號、學號和姓名
                if (student.id && student.name && student.seatNumber) {
                    students.push(student);
                } else {
                    console.warn("因缺少座號、學號或姓名而跳過此學生資料:", student, "於第", i + 1, "行");
                }
            } else { // 欄位數不符警告
                 console.warn(`因欄位數不符而跳過第 ${i+1} 行。預期 ${headers.length} 個欄位，實際為 ${values.length}。該行內容: "${lines[i]}"`);
            }
        }
        // 若處理後無學生資料但 CSV 中有多於一行（標頭行），則拋出錯誤
        if (students.length === 0 && lines.length > 1) {
            throw new Error("CSV 檔案中未找到有效的學生資料。請檢查欄位名稱和資料格式。");
        }
        classData[className] = students; // 儲存處理後的學生資料

        // 如果這是第一個加入的班級，自動選取
        if (Object.keys(classData).length === 1 && !currentClass) {
            selectClass(className);
        } else if (!currentClass && Object.keys(classData).length > 0) { // 若無選定班級但有班級資料，選取第一個
            selectClass(Object.keys(classData)[0]);
        }
        saveClassDataToLocalStorage(); // 持久化儲存資料
    }

    // 解析單行 CSV，處理引號內的逗號
    function parseCSVLine(line) {
        const result = [];
        let startPos = 0;
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            if (line[i] === '"') { // 處理引號
                if (inQuotes && i + 1 < line.length && line[i+1] === '"') { // 處理欄位內部的連續兩個引號 ( "" )
                    i++; // 跳過第二個引號
                } else {
                    inQuotes = !inQuotes; // 切換引號內外狀態
                }
            } else if (line[i] === ',' && !inQuotes) { // 若不在引號內且遇到逗號，則為欄位分隔
                let field = line.substring(startPos, i);
                // 移除欄位前後的引號 (若存在)
                if (field.startsWith('"') && field.endsWith('"')) {
                    field = field.substring(1, field.length - 1);
                }
                result.push(field.replace(/""/g, '"')); // 將欄位中連續兩個引號替換回一個引號
                startPos = i + 1; // 更新下一個欄位的起始位置
            }
        }
        // 加入最後一個欄位
        let lastField = line.substring(startPos);
        if (lastField.startsWith('"') && lastField.endsWith('"')) {
            lastField = lastField.substring(1, lastField.length - 1);
        }
        result.push(lastField.replace(/""/g, '"'));
        return result;
    }

    // --- UI 更新：班級與學生查詢下拉選單 ---
    function updateClassButtons() {
        classButtons.innerHTML = ''; // 清除現有按鈕
        const classNames = Object.keys(classData);
        if (classNames.length === 0) { // 若無班級資料
            const message = document.createElement('p');
            message.className = 'text-gray-500 text-sm';
            message.textContent = '尚未匯入任何班級資料，請點擊「匯入新班級資料」按鈕。';
            classButtons.appendChild(message);
            updateStudentSearchDropdowns(); // 清空學生下拉選單
            return;
        }
        classNames.forEach(className => { // 為每個班級創建按鈕
            const button = document.createElement('button');
            button.type = 'button';
            button.className = `class-badge px-4 py-2 rounded-full text-sm font-medium transition-colors duration-150 ease-in-out ${currentClass === className ? 'bg-indigo-600 text-white border border-transparent active' : 'bg-gray-100 text-gray-800 border border-gray-200 hover:bg-indigo-100 hover:text-indigo-800'}`;
            button.textContent = className;
            button.onclick = () => selectClass(className);
            classButtons.appendChild(button);
        });
    }

    function selectClass(className) {
        currentClass = className; // 更新目前選擇的班級
        saveClassDataToLocalStorage(); // 儲存選擇
        // 更新按鈕樣式以反映選定狀態
        document.querySelectorAll('#classButtons .class-badge').forEach(badge => {
            badge.classList.toggle('bg-indigo-600', badge.textContent === className);
            badge.classList.toggle('text-white', badge.textContent === className);
            badge.classList.toggle('border-transparent', badge.textContent === className);
            badge.classList.toggle('active', badge.textContent === className);
            badge.classList.toggle('bg-gray-100', badge.textContent !== className);
            badge.classList.toggle('text-gray-800', badge.textContent !== className);
            badge.classList.toggle('border-gray-200', badge.textContent !== className);
            badge.classList.toggle('hover:bg-indigo-100', badge.textContent !== className);
            badge.classList.toggle('hover:text-indigo-800', badge.textContent !== className);
        });
        resultsSection.classList.add('hidden'); // 隱藏結果區
        noResultsMessage.classList.add('hidden'); // 隱藏查無資料訊息
        updateStudentSearchDropdowns(); // 為新班級填入學生下拉選單
    }

    function updateStudentSearchDropdowns() {
        studentIdDropdown.innerHTML = ''; // 清空學號下拉選單
        studentNameDropdown.innerHTML = ''; // 清空姓名下拉選單
        // 加入預設提示選項
        const defaultIdOption = document.createElement('option');
        defaultIdOption.value = "";
        defaultIdOption.textContent = "請選擇學號";
        studentIdDropdown.appendChild(defaultIdOption);
        const defaultNameOption = document.createElement('option');
        defaultNameOption.value = "";
        defaultNameOption.textContent = "請選擇姓名";
        studentNameDropdown.appendChild(defaultNameOption);

        if (currentClass && classData[currentClass]) { // 若有選定班級且該班級有資料
            const studentsInClass = classData[currentClass];
            // 依座號排序 (若座號可轉換為數字)，再依學號排序
            studentsInClass.sort((a, b) => {
                const seatA = parseInt(a.seatNumber, 10);
                const seatB = parseInt(b.seatNumber, 10);
                if (!isNaN(seatA) && !isNaN(seatB)) {
                    if (seatA < seatB) return -1;
                    if (seatA > seatB) return 1;
                }
                if (a.id < b.id) return -1;
                if (a.id > b.id) return 1;
                return 0;
            });

            studentsInClass.forEach(student => { // 為每個學生加入選項
                if (student.id) { // 加入學號選項
                    const optionId = document.createElement('option');
                    optionId.value = student.id;
                    optionId.textContent = `${student.seatNumber || '無座號'} - ${student.id}`;
                    studentIdDropdown.appendChild(optionId);
                }
                if (student.name) { // 加入姓名選項
                    const optionName = document.createElement('option');
                    optionName.value = student.name; // 姓名選項的值為姓名本身
                    // 顯示文字包含座號、姓名和學號，以利區分同名學生
                    optionName.textContent = `${student.seatNumber || '無座號'} - ${student.name} (${student.id})`;
                    optionName.dataset.studentId = student.id; // 將學號存在 data-* 屬性中，方便同步
                    studentNameDropdown.appendChild(optionName);
                }
            });
        } else { // 若無選定班級或無學生資料
            studentIdDropdown.options[0].textContent = "請先選擇班級";
            studentNameDropdown.options[0].textContent = "請先選擇班級";
        }
    }

    // 當學號下拉選單變動時，同步姓名下拉選單
    function syncNameToId() {
        const selectedId = studentIdDropdown.value;
        if (selectedId && currentClass && classData[currentClass]) {
            const student = findStudentById(selectedId);
            if (student) {
                // 在姓名下拉選單中找到對應的學生並選取
                for(let i=0; i < studentNameDropdown.options.length; i++) {
                    if(studentNameDropdown.options[i].dataset.studentId === student.id) {
                        studentNameDropdown.selectedIndex = i;
                        break;
                    }
                }
            } else { // 若無對應學生，清空姓名選擇
                studentNameDropdown.value = "";
            }
        } else if (!selectedId) { // 若選擇 "請選擇學號"，清空姓名選擇
             studentNameDropdown.value = "";
        }
    }

    // 當姓名下拉選單變動時，同步學號下拉選單
    function syncIdToName() {
        const selectedNameOption = studentNameDropdown.options[studentNameDropdown.selectedIndex];
        if (selectedNameOption && selectedNameOption.value && currentClass && classData[currentClass]) {
            const studentIdToSync = selectedNameOption.dataset.studentId; // 從 data-* 屬性獲取學號
            if(studentIdToSync){
                studentIdDropdown.value = studentIdToSync;
            } else { // 若 data-* 屬性未設定 (正常情況下不會發生)
                const student = findStudentByName(selectedNameOption.value); // 備用：依姓名尋找 (可能不唯一)
                if (student) studentIdDropdown.value = student.id;
                else studentIdDropdown.value = "";
            }
        } else if (!selectedNameOption || !selectedNameOption.value) { // 若選擇 "請選擇姓名"，清空學號選擇
            studentIdDropdown.value = "";
        }
    }

    // --- 管理班級列表 (彈出視窗內) ---
    function updateClassesList() {
        classesList.innerHTML = ''; // 清空現有列表
        const classNames = Object.keys(classData);
        if (classNames.length === 0) { // 若無班級
            const messageItem = document.createElement('li');
            messageItem.className = 'p-3 text-center text-gray-500';
            messageItem.textContent = '尚未匯入任何班級資料';
            classesList.appendChild(messageItem);
            return;
        }
        classNames.forEach(className => { // 為每個班級創建列表項目
            const listItem = document.createElement('li');
            listItem.className = 'flex justify-between items-center p-3 hover:bg-gray-50';
            const classInfo = document.createElement('div');
            classInfo.innerHTML = `<p class="font-medium text-gray-800">${className}</p><p class="text-sm text-gray-500">${classData[className] ? classData[className].length : 0} 位學生</p>`;
            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.className = 'text-red-500 hover:text-red-700 p-1 rounded-md hover:bg-red-100 transition-colors';
            deleteButton.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>`;
            deleteButton.setAttribute('aria-label', `刪除 ${className} 班級`);
            deleteButton.onclick = () => deleteClass(className);
            listItem.appendChild(classInfo);
            listItem.appendChild(deleteButton);
            classesList.appendChild(listItem);
        });
    }

    function deleteClass(className) {
        if (confirm(`確定要刪除 ${className} 的資料嗎？此操作無法復原。`)) {
            delete classData[className]; // 從資料物件中刪除班級
            // 若刪除的是目前選定的班級，則重設 currentClass
            if (currentClass === className) {
                currentClass = Object.keys(classData)[0] || null; // 選取第一個可用班級或設為 null
                if (currentClass) selectClass(currentClass); // 自動選取新的目前班級
                else updateStudentSearchDropdowns(); // 若無班級，清空下拉選單
            }
            updateClassesList();    // 更新管理視窗中的列表
            updateClassButtons();   // 更新班級選擇按鈕
            if (!currentClass) { // 若已無任何班級
                resultsSection.classList.add('hidden');
                noResultsMessage.classList.add('hidden');
            }
            saveClassDataToLocalStorage(); // 持久化儲存變更
            showAlert(`${className} 已成功刪除。`, 'success');
        }
    }

    // --- LocalStorage 持久化儲存 ---
    function saveClassDataToLocalStorage() {
        try {
            // 使用不同的 key 以避免與舊版資料衝突
            localStorage.setItem('gradeSystemClassData_Gloria_v2', JSON.stringify(classData));
            if (currentClass) localStorage.setItem('gradeSystemCurrentClass_Gloria_v2', currentClass);
            else localStorage.removeItem('gradeSystemCurrentClass_Gloria_v2');
        } catch (e) {
            console.error('無法儲存資料到 localStorage:', e);
            showAlert('無法儲存資料，可能是localStorage已滿或不支援。', 'error');
        }
    }

    function loadClassDataFromLocalStorage() {
        try {
            const savedClassData = localStorage.getItem('gradeSystemClassData_Gloria_v2');
            const savedCurrentClass = localStorage.getItem('gradeSystemCurrentClass_Gloria_v2');
            if (savedClassData) classData = JSON.parse(savedClassData);
            if (savedCurrentClass && classData[savedCurrentClass]) currentClass = savedCurrentClass;
            else if (Object.keys(classData).length > 0) currentClass = Object.keys(classData)[0]; // 若無儲存的目前班級，預設第一個
        } catch (e) {
            console.error('無法從 localStorage 載入資料:', e);
            classData = {}; currentClass = null; // 載入失敗則重置
            showAlert('無法載入先前儲存的資料。', 'error');
        }
    }

    // --- 範例資料 ---
    function addSampleData() {
        if (Object.keys(classData).length > 0) return; // 若已有資料則不加入範例
        classData = {
            "三年級汽車科甲班 (範例)": [
                { seatNumber: "1", name: "陳大明", id: "S001", math4: "85", geography: "78", appliedMechanics: "92", chinese4: "88", english4: "75", diesel: "90", enginePrinciples: "86", classRank: "3", departmentGroupRank: "5", departmentYearRank: "10", generalTotalScore: "594", generalAverageScore: "84.86", weightedTotalScore: "605", weightedAverageScore: "86.43" },
                { seatNumber: "2", name: "林小華", id: "S002", math4: "76", geography: "82", appliedMechanics: "80", chinese4: "90", english4: "81", diesel: "78", enginePrinciples: "75", classRank: "10", departmentGroupRank: "15", departmentYearRank: "25", generalTotalScore: "562", generalAverageScore: "80.29", weightedTotalScore: "570", weightedAverageScore: "81.43" }
            ],
             "二年級資訊科乙班 (範例)": [
                { seatNumber: "1", name: "黃美玲", id: "S101", math4: "92", geography: "88", appliedMechanics: "N/A", chinese4: "85", english4: "90", diesel: "N/A", enginePrinciples: "N/A", classRank: "1", departmentGroupRank: "2", departmentYearRank: "3", generalTotalScore: "N/A", generalAverageScore: "88.75", weightedTotalScore: "N/A", weightedAverageScore: "89.50" }
            ]
        };
        if (!currentClass) currentClass = "三年級汽車科甲班 (範例)"; // 預設選取第一個範例班級
        saveClassDataToLocalStorage(); // 儲存範例資料
    }

    // --- 初始化 ---
    function init() {
        loadClassDataFromLocalStorage(); // 載入已儲存資料
        if (Object.keys(classData).length === 0) { // 若無資料則加入範例資料
            addSampleData();
        }
        updateClassButtons(); // 更新班級按鈕
        // 確保初始載入時，若有 currentClass，則選定並更新下拉選單
        if (currentClass && classData[currentClass]) {
            selectClass(currentClass);
        } else if (Object.keys(classData).length > 0) { // 若無 currentClass 但有班級資料，選取第一個
             selectClass(Object.keys(classData)[0]);
        } else { // 若完全無資料，確保下拉選單為預設狀態
            updateStudentSearchDropdowns();
        }
    }

    // DOM 完全載入後執行初始化
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
